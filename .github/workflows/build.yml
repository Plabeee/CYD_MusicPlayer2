# This workflow builds your Arduino sketch and creates a public release
# with the compiled .bin file.

name: Build and Release Firmware

on:
  push:
    branches:
      - 'main'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # This permission is required for the action to create a GitHub Release
    permissions:
      contents: write

    steps:
      # 1. Check out your code
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Set up the Arduino CLI
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # 3. Update the board index
      - name: Update Core Index
        run: arduino-cli core update-index

      # 4. Install the board platform
      # FIX 1: We explicitly install version 2.0.17.
      # ESP32 Core 3.x broke compatibility with many existing audio libraries.
      - name: Install ESP32 Core (v2.0.17)
        run: arduino-cli core install esp32:esp32@2.0.17

      # 5. Install Registry Libraries
      # FIX 2: Removed "FreeRTOS". It is built-in to the ESP32 Core.
      - name: Install Libraries
        run: |
           arduino-cli lib install "SdFat" "Adafruit GFX Library" "MultiButton"

      # 5.1 Install Custom Libraries via Git
      # FIX 3: Use git clone for cleaner folder structure (removes '-main' suffix)
      # and ensures we get the latest code.
      - name: Install Custom Libraries via Git
        run: |
          mkdir -p $HOME/Arduino/libraries
          cd $HOME/Arduino/libraries

          # Repo 1: arduino-audio-tools
          # We clone into specific folder names to ensure standard inclusion
          git clone -b main --depth 1 https://github.com/pschatzmann/arduino-audio-tools.git audio-tools

          # Repo 2: ESP32-A2DP
          git clone -b main --depth 1 https://github.com/pschatzmann/ESP32-A2DP.git ESP32-A2DP

          # Repo 3: arduino-libhelix
          git clone -b main --depth 1 https://github.com/pschatzmann/arduino-libhelix.git arduino-libhelix
                
      # 6. Compile the sketch
      # FIX 4: Added -DESP32 -DARDUINO_ARCH_ESP32 to build.extra_flags
      # This ensures the libraries know they are running on an ESP32, preventing
      # the "FreeRTOS.h" include error.
      - name: Compile Sketch
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property "build.extra_flags=-DESP32 -DARDUINO_ARCH_ESP32 -DUSER_SETUP_LOADED -DILI9341_2_DRIVER -DTFT_WIDTH=240 -DTFT_HEIGHT=320 -DTFT_MOSI=13 -DTFT_MISO=12 -DTFT_SCLK=14 -DTFT_CS=15 -DTFT_DC=2 -DTFT_RST=-1 -DTFT_BL=21 -DTFT_BACKLIGHT_ON=HIGH -DSPI_FREQUENCY=55000000 -DSPI_READ_FREQUENCY=20000000 -DSPI_TOUCH_FREQUENCY=2500000" \
            --output-dir ./build \
            ./CYD_MusicPlayer2.ino
      
      # 7. Create or Update the "latest" Release
      - name: Create or Update "latest" Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create latest \
            --title "Latest Build (main)" \
            --notes "Automatic build from the main branch." \
            --latest \
            --prerelease=false \
            --draft=false \
            --clobber \
            ./build/*.bin ./build/*.elf ./build/*.map
